#include <Arduino.h>
#include <Adafruit_GFX.h>
#include <SPI.h>
#include <Adafruit_GrayOLED.h>
#include <Adafruit_PCD8544.h>
#include <Servo.h>
#include <Ultrasonic.h>
#include <Bounce2.h>

#define BUTTON_MENU_PIN 10
int page = 0;

#define HC_SR04_TRIGGER A2
#define HC_SR04_ECHO A3
int distance = 0;

Adafruit_PCD8544 display = Adafruit_PCD8544(7, 6, 5, 4, 3);
Servo servo = Servo();
int locationOfObjects[180];


void clearArray()
{
  for (int i = 0; i < 180; ++i)
  {
    locationOfObjects[i] = 0;
  }
}

int getDistance()
{
  digitalWrite(HC_SR04_TRIGGER, LOW);
  delayMicroseconds(4);
  digitalWrite(HC_SR04_TRIGGER, HIGH);
  delayMicroseconds(20);
  digitalWrite(HC_SR04_TRIGGER, LOW);
  delayMicroseconds(10);
  long pulse_us = pulseIn(HC_SR04_ECHO, HIGH);
  int distance_cm = pulse_us / 54;
  return distance_cm;
}

void drawObjectLine(int value, int angle)
{
  int x0 = 42 - 41 * cos(angle * 3.14 / 180);
  int y0 = 48 - 41 * sin(angle * 3.14 / 180);
  int x1 = 42 - value * cos(angle * 3.14 / 180);
  int y1 = 48 - value * sin(angle * 3.14 / 180);
  display.drawLine(x1, y1, x0, y0, BLACK);
}

void drawDial(int angle)
{
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.write("Angle: ");
  display.print(angle);
  display.endWrite();
  display.drawCircle(42, 48, 41, BLACK);
  display.drawCircle(42, 48, 31, BLACK);
  display.drawCircle(42, 48, 21, BLACK);
  display.drawCircle(42, 48, 11, BLACK);
  int x = 42 - 41 * cos(angle * 3.14 / 180);
  int y = 48 - 41 * sin(angle * 3.14 / 180);
  display.drawLine(42, 48, x, y, BLACK);
}

void setup()
{
  pinMode(BUTTON_MENU_PIN, INPUT);
  pinMode(HC_SR04_TRIGGER, OUTPUT);
  pinMode(HC_SR04_ECHO, INPUT);
  for (int i = 0; i < 180; ++i)
  {
    if (20 + i < 41)
    {
      locationOfObjects[i] = 20 + i;
    }
    else
    {
      locationOfObjects[i] = 0;
    }
  }
  Serial.begin(9600);
  servo.attach(9);
  servo.write(0);
  servo.write(180);
  display.begin();
  display.setContrast(60);
  delay(2000);
  display.clearDisplay();
}

void ultrasonicRadar()
{
  for (int16_t i = 0; i < 180; ++i)
  {
    servo.write(180 - i);
    display.clearDisplay();
    drawDial(i);
    distance = getDistance();

    if (distance < 41)
      locationOfObjects[i] = distance;
    else
      locationOfObjects[i] = 0;

    int pos = i - 30;
    if (pos < 0)
      pos = 0;
    for (int k = pos; k < i; k++)
      if (locationOfObjects[k])
        drawObjectLine(locationOfObjects[k], k);
    display.display();
    delay(1);
  }
  clearArray();

  display.clearDisplay();
  for (int i = 180; i > 0; i--)
  {
    servo.write(180 - i);
    display.clearDisplay();
    drawDial(i);
    distance = getDistance();
    if (distance < 41)
      locationOfObjects[i] = distance;
    else
      locationOfObjects[i] = 0;

    int pos = i + 30;
    if (pos > 179)
      pos = 179;
    for (int k = pos; k > i; k--)
      if (locationOfObjects[k])
        drawObjectLine(locationOfObjects[k], k);

    display.display();
    delay(1);
  }
  clearArray();
}

unsigned long clicked = millis();

void distanceCalculator() {
  Serial.println("This is a calculator func");
}

void loop()
{
  ultrasonicRadar();
}